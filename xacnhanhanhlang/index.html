<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Hồ Sơ An Toàn Lưới Điện - Ver 1.3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .screen {
            display: none; /* Ẩn tất cả màn hình mặc định */
            min-height: 100vh;
        }
        .active-screen {
            display: flex; /* Chỉ hiện màn hình active */
            flex-direction: column;
        }
        .login-container {
            max-width: 400px;
            margin: auto;
            padding-top: 100px;
        }
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .btn-google {
            background-color: #fff;
            color: #333;
            border: 1px solid #ddd;
            font-weight: 500;
        }
        .btn-google:hover {
            background-color: #f8f9fa;
        }
        #version-tag {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 0.8rem;
            color: #888;
            opacity: 0.7;
        }
        /* Loader */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Đang tải dữ liệu...</p>
        </div>
    </div>

    <div id="login-screen" class="screen container">
        <div class="login-container">
            <div class="card p-4 text-center">
                <div class="mb-4">
                    <i class="fas fa-bolt fa-3x text-warning"></i>
                    <h3 class="mt-3 fw-bold">An Toàn Lưới Điện</h3>
                    <p class="text-muted">Hệ thống quản lý hồ sơ thỏa thuận</p>
                </div>
                <div class="d-grid gap-2">
                    <button id="btnLogin" class="btn btn-google btn-lg">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" width="20" class="me-2">
                        Đăng nhập bằng Gmail
                    </button>
                </div>
                <div class="mt-4 text-muted small">
                    Phiên bản 1.3 - Dành cho nội bộ
                </div>
            </div>
        </div>
    </div>

    <div id="update-info-screen" class="screen container">
        <div class="login-container" style="padding-top: 50px;">
            <div class="card p-4">
                <h4 class="mb-3 text-primary"><i class="fas fa-user-edit me-2"></i>Cập nhật thông tin</h4>
                <p class="text-muted small">Bạn đăng nhập lần đầu. Vui lòng cập nhật thông tin để tiếp tục.</p>
                
                <form id="formUpdateInfo">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" id="userEmail" class="form-control" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Họ và Tên <span class="text-danger">*</span></label>
                        <input type="text" id="userName" class="form-control" placeholder="Ví dụ: Nguyễn Văn A" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                        <input type="tel" id="userPhone" class="form-control" placeholder="09xxxxxxx" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Chức danh</label>
                        <select id="userRole" class="form-select">
                            <option value="Chuyên viên">Chuyên viên</option>
                            <option value="Tổ trưởng">Tổ trưởng</option>
                            <option value="Văn thư">Văn thư</option>
                        </select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Lưu & Tiếp tục</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="dashboard-screen" class="screen">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="#"><i class="fas fa-bolt me-2"></i>QLHS Lưới Điện</a>
                <div class="d-flex align-items-center text-white">
                    <div class="me-3 text-end d-none d-sm-block">
                        <div class="fw-bold" id="navUserName">Loading...</div>
                        <div class="small opacity-75" id="navUserRole">Loading...</div>
                    </div>
                    <button id="btnLogout" class="btn btn-sm btn-light text-primary fw-bold">
                        <i class="fas fa-sign-out-alt me-1"></i> Thoát
                    </button>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <div class="row">
                <div class="col-md-12">
                    <div class="card p-5 text-center">
                        <h2 class="text-muted mb-3">Chào mừng đến hệ thống</h2>
                        <p>Hệ thống đang được xây dựng. Chức năng quản lý hồ sơ sẽ xuất hiện ở đây.</p>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary"><i class="fas fa-plus me-2"></i>Tạo hồ sơ mới</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="version-tag">Ver 1.3</div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- 1. CẤU HÌNH FIREBASE ---
        const firebaseConfig = { 
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
            authDomain: "tavietnam-78ae8.firebaseapp.com", 
            projectId: "tavietnam-78ae8", 
            storageBucket: "tavietnam-78ae8.firebasestorage.app", 
            messagingSenderId: "670121705534", 
            appId: "1:670121705534:web:1027ad98550573ad37116f" 
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        // --- 2. QUẢN LÝ GIAO DIỆN (UI MANAGER) ---
        const UI = {
            screens: {
                login: document.getElementById('login-screen'),
                updateInfo: document.getElementById('update-info-screen'),
                dashboard: document.getElementById('dashboard-screen')
            },
            loader: document.getElementById('loading-overlay'),
            
            showScreen(screenName) {
                // Ẩn tất cả
                Object.values(this.screens).forEach(el => el.classList.remove('active-screen'));
                // Hiện màn hình cần thiết
                this.screens[screenName].classList.add('active-screen');
                // Tắt loader
                this.toggleLoader(false);
            },

            toggleLoader(show) {
                this.loader.style.display = show ? 'flex' : 'none';
            }
        };

        // --- 3. LOGIC XÁC THỰC (AUTH LOGIC) ---
        
        // Lắng nghe trạng thái đăng nhập
        auth.onAuthStateChanged(async (user) => {
            UI.toggleLoader(true);
            
            if (user) {
                console.log("User detected:", user.email);
                await checkUserProfile(user);
            } else {
                console.log("No user");
                UI.showScreen('login');
            }
        });

        // Hàm kiểm tra profile trong Firestore
        async function checkUserProfile(user) {
            try {
                const userRef = db.collection('users').doc(user.email);
                const doc = await userRef.get();

                if (doc.exists) {
                    // Trường hợp A: Đã có thông tin -> Vào Dashboard
                    const userData = doc.data();
                    setupDashboard(userData);
                    UI.showScreen('dashboard');
                } else {
                    // Trường hợp B: Chưa có thông tin -> Vào trang cập nhật
                    document.getElementById('userEmail').value = user.email;
                    // Tự động điền tên từ Google nếu có
                    if(user.displayName) document.getElementById('userName').value = user.displayName;
                    UI.showScreen('updateInfo');
                }
            } catch (error) {
                console.error("Lỗi kiểm tra profile:", error);
                alert("Lỗi kết nối cơ sở dữ liệu!");
                UI.showScreen('login');
            }
        }

        // Thiết lập thông tin Dashboard
        function setupDashboard(userData) {
            document.getElementById('navUserName').textContent = userData.fullName;
            document.getElementById('navUserRole').textContent = userData.role || 'Nhân viên';
        }

        // --- 4. XỬ LÝ SỰ KIỆN (EVENT HANDLERS) ---

        // Nút Đăng nhập Google
        document.getElementById('btnLogin').addEventListener('click', () => {
            auth.signInWithPopup(provider).catch((error) => {
                console.error("Login failed:", error);
                alert("Đăng nhập thất bại: " + error.message);
            });
        });

        // Nút Đăng xuất
        document.getElementById('btnLogout').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.reload();
            });
        });

        // Form Cập nhật thông tin
        document.getElementById('formUpdateInfo').addEventListener('submit', async (e) => {
            e.preventDefault();
            UI.toggleLoader(true);

            const user = auth.currentUser;
            if (!user) return;

            const fullName = document.getElementById('userName').value;
            const phone = document.getElementById('userPhone').value;
            const role = document.getElementById('userRole').value;

            try {
                // Lưu vào Firestore
                await db.collection('users').doc(user.email).set({
                    email: user.email,
                    fullName: fullName,
                    phone: phone,
                    role: role,
                    uid: user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Chuyển hướng vào Dashboard
                setupDashboard({ fullName, role });
                UI.showScreen('dashboard');

            } catch (error) {
                console.error("Error saving profile:", error);
                alert("Lỗi khi lưu thông tin: " + error.message);
                UI.toggleLoader(false);
            }
        });

    </script>
</body>
</html>
